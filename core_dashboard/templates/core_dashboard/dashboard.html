{% extends "core_dashboard/base.html" %}

{% block content %}
{% load progress_bar humanize %}
<style>
    /* Prevent horizontal overflow and improve dashboard fit */
    html, body {
        overflow-x: hidden;
        min-width: 0;
    }
    .card { word-wrap: break-word; }
    .flip-card {
        background-color: transparent;
        width: 100%;
        aspect-ratio: 1 / 1; /* force square cards */
        max-height: 420px; /* avoid excessively tall squares on very wide screens */
        perspective: 1000px;
        display: block;
    }

    .flip-card { cursor: pointer; }

    .flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    display: flex;
    flex-direction: column;
        background-color: var(--ey-dark-grey);
        color: white;
        border-radius: .25rem; /* Match card style */
    }

    .flip-card-back {
        transform: rotateY(180deg);
        padding: 0.5rem;
        overflow: hidden; /* contain scroll inside inner body */
    }

    /* Ensure inner body scrolls if content overflows the square */
    .flip-card-front .card-body, .flip-card-back .table-responsive {
        overflow-y: auto;
        padding: .5rem;
    }

    #filterBody {
        min-height: 150px; /* Ensure filter body has a minimum height */
    }

    /* Macro card sizing: slightly smaller cards, tighter padding, and slightly reduced KPI font
       This keeps the dashboard fit while improving proportions for numeric values. */
    .macro-row .card {
        padding: 0.6rem; /* reduce inner padding */
        min-height: 170px; /* larger to accommodate bigger KPI font */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .macro-row .card .card-body { padding-top: .4rem; padding-bottom: .4rem; }

    .macro-row .kpi-card-value {
        font-size: 3rem; /* increased for prominent visibility */
        line-height: 1.02;
        font-weight: 700;
    }

    .macro-row .card-header {
        font-size: 0.9rem;
        padding: .35rem .6rem;
    }

    /* Add a bit more horizontal gap between macro columns on larger screens */
    @media (min-width: 768px) {
        .macro-row > .col-md-4 { padding-left: .6rem; padding-right: .6rem; }
    }

    /* Use Bootstrap columns for layout; enforce square flip-cards inside columns for consistent look */
    .flip-card { aspect-ratio: 1 / 1; width: 100%; max-height: 420px; }
    /* On very small screens, allow flip-cards to be slightly taller to fit content */
    @media (max-width: 575.98px) {
        .flip-card { aspect-ratio: auto; height: 320px; }
    }

    /* Default smaller screens: stack as single column unless overridden by media queries */
    .ranking-col {
        box-sizing: border-box;
        padding-left: .25rem;
        padding-right: .25rem;
        width: 100%;
        max-width: 100%;
        display: block;
    }

    /* Medium screens: two columns */
    @media (min-width: 768px) {
        /* Make 4 columns at tablet+ sizes so tiles sit horizontally on most desktops */
        .ranking-row { grid-template-columns: repeat(4, 1fr) !important; }
    }

    /* Large and up: four equal columns, non-wrapping */
    @media (min-width: 992px) {
        /* Strict 4-column grid on large screens */
        .ranking-row { grid-template-columns: repeat(4, 1fr) !important; }
        .ranking-col { width: auto; max-width: none; }
    }

    /* Visual polish for flip-cards: card-like look, rounded corners and hidden overflow so inner scroll works */
    .ranking-col .flip-card { width: 100%; display: block; overflow: hidden; border-radius: .25rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .flip-card-front .card-header, .flip-card-back .card-title { padding: .6rem .75rem; }
</style>

<h3 class="section-title">Data Filtering</h3>
<!-- Filter Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header filter-header" data-bs-toggle="collapse" data-bs-target="#filterBody" aria-expanded="true" aria-controls="filterBody">
                Filter Data <span class="toggle-icon material-icons-round">expand_more</span>
            </div>
            <div id="filterBody" class="collapse show card-body">
                <form method="GET" action="{% url 'dashboard' %}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="partnerSelect" class="form-label">Partner</label>
                            <select class="form-select" id="partnerSelect" name="partner">
                                <option value="">All Partners</option>
                                {% for partner in partners %}
                                    <option value="{{ partner }}" {% if selected_partner == partner %}selected{% endif %}>{{ partner }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="managerSelect" class="form-label">Manager</label>
                            <select class="form-select" id="managerSelect" name="manager">
                                <option value="">All Managers</option>
                                {% for manager in managers %}
                                    <option value="{{ manager }}" {% if selected_manager == manager %}selected{% endif %}>{{ manager }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="areaSelect" class="form-label">Service Line</label>
                            <select class="form-select" id="areaSelect" name="service_line">
                                <option value="">All SL</option>
                                {% for area in areas %}
                                    <option value="{{ area }}" {% if selected_area == area %}selected{% endif %}>{{ area }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="subAreaSelect" class="form-label">Sub Service Line</label>
                            <select class="form-select" id="subAreaSelect" name="sub_service_line">
                                <option value="">All SSL</option>
                                {% for sub_area in sub_areas %}
                                    <option value="{{ sub_area }}" {% if selected_sub_area == sub_area %}selected{% endif %}>{{ sub_area }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="clientSelect" class="form-label">Client</label>
                            <select class="form-select" id="clientSelect" name="client">
                                <option value="">All Clients</option>
                                {% for client in clients %}
                                    <option value="{{ client }}" {% if selected_client == client %}selected{% endif %}>{{ client }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="weekSelect" class="form-label">Week</label>
                            <select class="form-select" id="weekSelect" name="week">
                                <option value="">All Weeks</option>
                                {% for week in available_weeks %}
                                    <option value="{{ week }}" {% if selected_week == week %}selected{% endif %}>{{ week }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-primary">Filter</button>
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Clear Filters</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if partner_spec_data %}
<h3 class="section-title">Partner Specification: {{ selected_partner }}</h3>
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">Number of Engagements</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.num_engagements }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">Number of Clients</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.num_clients }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">Revenue Days</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.revenue_days }}</h3>
            </div>
        </div>
    </div>
    {% if partner_spec_data.mtd_ansr_amt %}
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">MTD ANSR (Client: {{ selected_client }})</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.mtd_ansr_amt }}</h3>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">FYTD ANSR</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ partner_spec_data.partner_fytd_ansr_value|floatformat:0|intcomma }}</h3>
                <div class="progress mt-2">
                    {% with completion=partner_spec_data.partner_fytd_ansr_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white">(${% if partner_spec_data.partner_fytd_ansr_goal %}{{ partner_spec_data.partner_fytd_ansr_goal|floatformat:0 }}{% else %}0{% endif %})</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">MTD ANSR</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ partner_spec_data.partner_mtd_ansr_value|floatformat:0|intcomma }}</h3>
                <div class="progress mt-2">
                    {% with completion=partner_spec_data.partner_mtd_ansr_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white">(${% if partner_spec_data.partner_mtd_ansr_goal %}{{ partner_spec_data.partner_mtd_ansr_goal|floatformat:0 }}{% else %}0{% endif %})</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">Horas Cargadas (FYTD)</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.partner_fytd_charged_hours|floatformat:1 }}</h3>
                <div class="progress mt-2">
                    {% with completion=partner_spec_data.partner_fytd_hours_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white">({% if partner_spec_data.partner_fytd_hours_goal %}{{ partner_spec_data.partner_fytd_hours_goal|floatformat:0 }}{% else %}0{% endif %})</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-header">Horas Cargadas (MTD)</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ partner_spec_data.partner_mtd_charged_hours|floatformat:1 }}</h3>
                <div class="progress mt-2">
                    {% with completion=partner_spec_data.partner_mtd_hours_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white">({% if partner_spec_data.partner_mtd_hours_goal %}{{ partner_spec_data.partner_mtd_hours_goal|floatformat:0 }}{% else %}0{% endif %})</small>
            </div>
        </div>
    </div>
    <!-- Display FYTD_ChargedHours and MTD_Charged in the filter per partner -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Charged Hours by Partner</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Partner</th>
                                <th scope="col">Horas Cargadas (FYTD)</th>
                                <th scope="col">Horas Cargadas (MTD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fytd_entry in fytd_charged_hours_by_partner_with_labels %}
                            <tr>
                                <td>{{ fytd_entry.engagement_partner }}</td>
                                <td>{{ fytd_entry.total_fytd_charged_hours|floatformat:1 }}</td>
                                <td>
                                    {% for mtd_entry in mtd_charged_hours_by_partner_with_labels %}
                                        {% if mtd_entry.engagement_partner == fytd_entry.engagement_partner %}
                                            {{ mtd_entry.total_mtd_charged_hours|floatformat:1 }}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Client List & Revenue</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for client in partner_spec_data.client_list %}
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                        {{ client.name }}
                        <span class="badge bg-primary rounded-pill">{{ client.revenue }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Charged Hours by Manager</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Manager</th>
                                <th scope="col">FYTD Charged Hours</th>
                                <th scope="col">MTD Charged Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for manager_fytd in fytd_charged_hours_by_manager %}
                            <tr>
                                <td>{{ manager_fytd.engagement_manager }}</td>
                                <td>{{ manager_fytd.total_fytd_charged_hours|floatformat:1 }}</td>
                                <td>
                                    {% for manager_mtd in mtd_charged_hours_by_manager %}
                                        {% if manager_mtd.engagement_manager == manager_fytd.engagement_manager %}
                                            {{ manager_mtd.total_mtd_charged_hours|floatformat:1 }}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-header">Total Perdida Diferencial</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ partner_spec_data.total_perdida_diferencial|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Perdida Diferencial by Client</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for item in partner_spec_data.perdida_per_client %}
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                        {{ item.client_name }}
                        <span class="badge bg-danger rounded-pill">${{ item.perdida|floatformat:0|intcomma }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Top 5 Engagements by Perdida Diferencial</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for item in partner_spec_data.top_engagements_perdida %}
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                        {{ item.engagement_name }}
                        <span class="badge bg-danger rounded-pill">${{ item.perdida|floatformat:0|intcomma }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if not selected_partner %}
<h3 class="section-title">Macro</h3>

<!-- First row: YTD values (ANSR, Horas, Margin) -->
<div class="row mb-3 macro-row">
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">ANSR YTD</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ ansr_fytd_value|floatformat:0|intcomma }}</h3>
                <div class="progress mt-2">
                    {% with completion=ansr_fytd_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white d-block">(${{ ansr_fytd_goal|floatformat:0|intcomma }})</small>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">Horas Cargadas (YTD)</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ total_fytd_charged_hours }}</h3>
                <div class="progress mt-2">
                    {% with completion=hours_fytd_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white d-block">({{ hours_fytd_goal|floatformat:0 }})</small>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">Margin</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ macro_margin_percentage_value|floatformat:0 }}%</h3>
                <small class="text-white d-block mt-2">${{ macro_margin_value|default:0|floatformat:0|intcomma }}</small>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
</div>

<!-- Second row: MTD values (ANSR MTD under ANSR YTD, Horas MTD under Horas YTD, Perdida under Margin) -->
<div class="row mb-3 macro-row">
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">ANSR MTD</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ ansr_mtd_value|floatformat:0|intcomma }}</h3>
                <div class="progress mt-2">
                    {% with completion=ansr_mtd_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white d-block">(${{ ansr_mtd_goal|floatformat:0|intcomma }})</small>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">Horas Cargadas (MTD)</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">{{ total_mtd_charged_hours }}</h3>
                <div class="progress mt-2">
                    {% with completion=hours_mtd_completion_percentage %}
                    <div class="progress-bar {% if completion >= 95 %}bg-success{% elif completion >= 50 %}bg-warning{% else %}bg-danger{% endif %} {% if completion == 0 %}text-dark{% else %}text-white{% endif %}" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion|floatformat:0 }}%</div>
                    {% endwith %}
                </div>
                <small class="text-white d-block">({{ hours_mtd_goal|floatformat:0 }})</small>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12 mb-2">
        <div class="card text-center h-100 macro-card" data-report-date="{{ latest_report_date }}">
            <div class="card-header">Perdida Diferencial</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ macro_diferencial_final|floatformat:0|intcomma }}</h3>
                <a class="btn btn-sm btn-secondary preview-btn position-absolute" style="left: .5rem; bottom: .5rem;" href="{% url 'data_downloads' %}?report_date={{ latest_report_date }}">Preview</a>
            </div>
        </div>
    </div>
</div>

<!-- RPH centered full-width bar below -->
<div class="row mb-4 macro-row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-header">RPH</div>
            <div class="card-body">
                <h3 class="card-title kpi-card-value">${{ macro_rph_value|floatformat:1 }}</h3>
            </div>
        </div>
    </div>
</div>
{% endif %}

<h3 class="section-title">Key Performance Indicators</h3>

<!-- Two-column layout: left column = Partners (top) / Engagements (bottom); right column = Managers (top) / Clients (bottom) -->
<div class="row mb-3">
    <div class="col-md-6 col-sm-12 mb-2">
        <!-- Top Partners (wider) -->
        <div class="flip-card h-100" id="topPartnersFlipCard" role="button" tabindex="0" aria-pressed="false">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <div class="card-header w-100">Top 5 Partners by Revenue</div>
                    <div class="card-body w-100" style="overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for partner in top_partners %}
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                                {{ partner.engagement_partner }}
                                <span class="badge bg-primary rounded-pill">{{ partner.total_revenue }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="flip-card-back">
                    <h5 class="card-title">All Partners by Revenue & Charged Hours (FYTD)</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Partner</th>
                                    <th scope="col">Revenue</th>
                                    <th scope="col">Charged Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for partner in all_partners_ranked %}
                                <tr>
                                    <td>{{ partner.engagement_partner }}</td>
                                    <td>{{ partner.total_revenue }}</td>
                                    <td>
                                        {% for hours_entry in all_fytd_charged_hours_by_partner %}
                                            {% if hours_entry.engagement_partner == partner.engagement_partner %}
                                                {{ hours_entry.total_fytd_charged_hours|floatformat:1 }}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Engagements under Partners (same size) -->
        <div class="flip-card h-100 mt-2" id="topEngagementsFlipCard" role="button" tabindex="0" aria-pressed="false">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <div class="card-header w-100">Top 5 Engagements by Revenue</div>
                    <div class="card-body w-100" style="overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for e in top_engagements %}
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                                {{ e.label }}
                                <span class="badge bg-primary rounded-pill">${{ e.total_revenue|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="flip-card-back">
                    <h5 class="card-title">All Engagements by Revenue</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr><th>Engagement</th><th>Revenue</th></tr>
                            </thead>
                            <tbody>
                                {% for e in all_engagements_ranked %}
                                <tr><td>{{ e.label }}</td><td>${{ e.total_revenue|floatformat:2 }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-sm-12 mb-2">
        <!-- Top Managers (wider) -->
        <div class="flip-card h-100" id="topManagersFlipCard" role="button" tabindex="0" aria-pressed="false">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <div class="card-header w-100">Top 5 Managers by Revenue</div>
                    <div class="card-body w-100" style="overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for m in top_managers %}
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                                {{ m.label }}
                                <span class="badge bg-primary rounded-pill">${{ m.total_revenue|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="flip-card-back">
                    <h5 class="card-title">All Managers by Revenue</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr><th>Manager</th><th>Revenue</th></tr>
                            </thead>
                            <tbody>
                                {% for m in all_managers_ranked %}
                                <tr><td>{{ m.label }}</td><td>${{ m.total_revenue|floatformat:2 }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clients under Managers (same size) -->
        <div class="flip-card h-100 mt-2" id="topClientsFlipCard" role="button" tabindex="0" aria-pressed="false">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <div class="card-header w-100">Top 5 Clients by Revenue</div>
                    <div class="card-body w-100" style="overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for c in top_clients_rank %}
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                                {{ c.label }}
                                <span class="badge bg-primary rounded-pill">${{ c.total_revenue|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="flip-card-back">
                    <h5 class="card-title">All Clients by Revenue</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr><th>Client</th><th>Revenue</th></tr>
                            </thead>
                            <tbody>
                                {% for c in all_clients_ranked %}
                                <tr><td>{{ c.label }}</td><td>${{ c.total_revenue|floatformat:2 }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header filter-header" data-bs-toggle="collapse" data-bs-target="#exchangeRateGraphBody" aria-expanded="true" aria-controls="exchangeRateGraphBody">
                Exchange Rate Differential Trends <span class="toggle-icon material-icons-round">expand_more</span>
            </div>
            <div id="exchangeRateGraphBody" class="collapse show card-body">
                <div id="exchangeRateChart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Revenue Visualizations removed per request -->

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.querySelector('form');
        const selects = filterForm.querySelectorAll('select');

        selects.forEach(select => {
            select.addEventListener('change', function() {
                filterForm.submit();
            });
        });

        // Flip behavior: attach to all .flip-card elements (click or Enter/Space)
        document.querySelectorAll('.flip-card').forEach(card => {
            const toggleFlip = (e) => {
                if (e.target.closest && e.target.closest('a, button')) return;
                card.classList.toggle('flipped');
                card.setAttribute('aria-pressed', card.classList.contains('flipped'));
            };

            card.addEventListener('click', toggleFlip);
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleFlip(e);
                }
            });
        });
    });

    // Exchange Rate Chart (Plotly)
    if (document.getElementById('exchangeRateChart')) {
    const exchangeDates = JSON.parse('{{ exchange_dates|default:'[]'|escapejs }}');
    const oficialRatesHistory = JSON.parse('{{ oficial_rates_history|default:'[]'|escapejs }}');
    const paraleloRatesHistory = JSON.parse('{{ paralelo_rates_history|default:'[]'|escapejs }}');
    const differentialHistory = JSON.parse('{{ differential_history|default:'[]'|escapejs }}');

        const traceOficial = {
            x: exchangeDates,
            y: oficialRatesHistory,
            mode: 'lines',
            name: 'Oficial Rate',
            line: {color: 'var(--ey-white)'} // Use EY white
        };

        const traceParalelo = {
            x: exchangeDates,
            y: paraleloRatesHistory,
            mode: 'lines',
            name: 'Paralelo Rate',
            line: {color: 'var(--ey-white)'} // Use EY white
        };

        const traceDifferential = {
            x: exchangeDates,
            y: differentialHistory,
            mode: 'lines',
            name: 'Differential',
            line: {color: 'var(--ey-green)', dash: 'dot'} // Use EY green, dotted line
        };

        const layout = {
            title: 'Historical Exchange Rates and Differential',
            plot_bgcolor: 'var(--ey-dark-grey)', // Card background
            paper_bgcolor: 'var(--ey-dark-grey)', // Card background
            font: {
                color: 'var(--ey-white)' // Text color
            },
            xaxis: {
                title: 'Date',
                tickfont: { color: 'var(--ey-white)' },
                gridcolor: 'var(--ey-medium-grey)'
            },
            yaxis: {
                title: 'Rate (VES)',
                tickfont: { color: 'var(--ey-white)' },
                gridcolor: 'var(--ey-medium-grey)'
            },
            legend: {
                font: { color: 'var(--ey-white)' }
            }
        };

        Plotly.newPlot('exchangeRateChart', [traceOficial, traceParalelo, traceDifferential], layout);
    }

    // Revenue charts removed per request

    // Add JS to make macro cards clickable (but not the preview button)
    document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.macro-card').forEach(card => {
        const reportDate = card.getAttribute('data-report-date');
        if (!reportDate) return; // nothing to link to
        const previewUrl = `{% url 'data_downloads' %}?report_date=` + encodeURIComponent(reportDate);
        // Click on the card body (not the preview button) navigates to preview
        card.addEventListener('click', (e) => {
            if (e.target.closest('.preview-btn') || e.target.closest('a, button')) return; // ignore clicks on the preview button or links
            window.location.href = previewUrl;
        });
    });
});
</script>
{% endblock %}